---
name: Publish distributions

on:
  push:
    branches:
      - v[0-9]+.*
  workflow_dispatch:
    inputs:
      version:
        description: 'Tag to publish'
        required: true
        default: 'v0.0.0'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  VERSION: ${{ github.event.inputs.version || github.ref_name }}
  BUILDS: ${{ contains(github.event.inputs.version || github.ref_name, '-rc') && 'experimental-only' || 'all' }}
  RELEASE_NOTES: ''

jobs:
  publish-tauri:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'macos-latest'
            args: '--target universal-apple-darwin'
          - platform: 'windows-latest'
            args: ''
          - platform: 'ubuntu-22.04'
            args: ''

    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v4

      - name: Free disk space (Ubuntu runner)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          set -euxo pipefail
          df -h
          sudo rm -rf /usr/local/lib/android || true
          sudo rm -rf /usr/share/dotnet || true
          sudo rm -rf /opt/ghc || true
          sudo rm -rf /opt/hostedtoolcache/CodeQL || true
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*
          df -h

      - name: setup node
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: yarn

      - name: install Rust stable (macOS)
        uses: dtolnay/rust-toolchain@stable

      - name: Ensure Rust macOS targets
        if: ${{ matrix.platform == 'macos-latest' }}
        run: |
          set -euxo pipefail
          rustup show active-toolchain
          rustup target list --installed || true
          rustup target add aarch64-apple-darwin x86_64-apple-darwin
          rustup target list --installed

      - name: install dependencies (ubuntu only)
        if: matrix.platform == 'ubuntu-22.04' # This must match the platform value defined above.
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: install dependencies (macOS only)
        if: matrix.platform == 'macos-latest'
        run: |
          brew install create-dmg

      - if: runner.os == 'Windows'
        shell: bash
        run: echo "AWS_LC_SYS_PREBUILT_NASM=1" >> "$GITHUB_ENV"

      - name: Install SQLite on Windows
        if: runner.os == 'Windows'
        run: choco install sqlite

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: install frontend dependencies
        run: yarn install

      - name: Read release notes (and ensure they exist)
        shell: bash
        run: |
          RELEASE_NOTES=$(yarn tsx scripts/getReleaseNotes.ts "$VERSION")
          if [ -z "$RELEASE_NOTES" ]; then
              echo "Release notes are empty. Please provide valid release notes."
              exit 1
          fi
          {
            echo 'RELEASE_NOTES<<__EOF__'
            echo "$RELEASE_NOTES"
            echo '__EOF__'
          } >> "$GITHUB_ENV"

      - name: build server
        run: yarn build:server

      - name: Build and Publish Operations Stable
        if: ${{ env.BUILDS == 'all' }}
        uses: tauri-apps/tauri-action@v0.6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          ARGON_APP_ENABLE_AUTOUPDATE: true
          NODE_ENV: production
          NODE_OPTIONS: --max-old-space-size=6144
          RUST_BACKTRACE: full
        with:
          includeDebug: true
          includeRelease: true
          includeUpdaterJson: false
          tagName: ${{ env.VERSION }}
          releaseName: ${{ env.VERSION }}
          releaseBody: ${{ env.RELEASE_NOTES }}
          releaseDraft: true
          prerelease: true
          args: ${{ matrix.args }} --config ${{ github.workspace }}/src-tauri/tauri.operations.conf.json

      - name: Build and Publish Investments Stable
        if: ${{ env.BUILDS == 'all' }}
        uses: tauri-apps/tauri-action@v0.6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          ARGON_APP_ENABLE_AUTOUPDATE: true
          NODE_ENV: production
          NODE_OPTIONS: --max-old-space-size=6144
          RUST_BACKTRACE: full
        with:
          includeDebug: true
          includeRelease: true
          includeUpdaterJson: false
          tagName: ${{ env.VERSION }}
          releaseName: ${{ env.VERSION }}
          releaseBody: ${{ env.RELEASE_NOTES }}
          releaseDraft: true
          prerelease: true
          args: ${{ matrix.args }} --config ${{ github.workspace }}/src-tauri/tauri.investments.conf.json

      - name: Build and Publish Operations Experimental
        uses: tauri-apps/tauri-action@v0.6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          ARGON_APP_ENABLE_AUTOUPDATE: true
          NODE_ENV: production
          NODE_OPTIONS: --max-old-space-size=6144
          RUST_BACKTRACE: full
        with:
          includeDebug: true
          includeRelease: false
          includeUpdaterJson: false
          tagName: ${{ env.VERSION }}
          releaseName: ${{ env.VERSION }}
          releaseBody: ${{ env.RELEASE_NOTES }}
          releaseDraft: true
          prerelease: true
          args: ${{ matrix.args }} --config ${{ github.workspace }}/src-tauri/tauri.operations.experimental.conf.json

      - name: Build and Publish Investments Experimental
        uses: tauri-apps/tauri-action@v0.6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          ARGON_APP_ENABLE_AUTOUPDATE: true
          NODE_ENV: production
          NODE_OPTIONS: --max-old-space-size=6144
          RUST_BACKTRACE: full
        with:
          includeDebug: true
          includeRelease: false
          includeUpdaterJson: false
          tagName: ${{ env.VERSION }}
          releaseName: ${{ env.VERSION }}
          releaseBody: ${{ env.RELEASE_NOTES }}
          releaseDraft: true
          prerelease: true
          args: ${{ matrix.args }} --config ${{ github.workspace }}/src-tauri/tauri.investments.experimental.conf.json

      - name: Upload server artifacts
        if: ${{ matrix.platform == 'macos-latest' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          tar -czf server.tar.gz ./resources/*
          gh release upload ${{ env.VERSION }} server.tar.gz --clobber

  publish-update-channel:
    permissions:
      contents: write
    needs: publish-tauri
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: yarn

      - name: install dependencies
        run: yarn install

      - name: Publish to channel release
        run: yarn tsx scripts/updateReleaseChannels.ts
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          VERSION: ${{ env.VERSION }}
          RELEASE_NOTES: ${{ env.RELEASE_NOTES }}

